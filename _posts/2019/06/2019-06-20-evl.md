---
title: EVL Real-Time Kernel on 96boards
author: Servando German Serrano
date: 2019-06-20 01:01:54+00:00
image:
    featured: true
    path: /assets/images/blog/wistrio.jpg
    name: wistrio.jpg
    thumb: wistrio-thumb.jpg
categories: blog
tags: 96Boards, EVL, Real-Time
---

### Introduction
In this blog we will cover the steps needed to enable the EVL Kernel on 96boards. We will cross-compile the kernel and flash it afterwards.

#### Evenless
[The EVL Project](https://evlproject.org/) aims at providing Real-Time capabilities based on a dual kernel approach.
For the purposes of this blog Hikey970 is used but a number of SoCs are already supported by EVL: [EVL ports](https://evlproject.org/ports/).

#### Board preparation
Since the upstream kernel version 5.x does not provide HDMI drivers for the Hikey970 we need to set it up so SSH access can be seamlessly achieved when powering up the board. Otherwise, after flashing the upgraded kernel we will not be able to access the board.

To set up the board I have used the [Bionic Builder](https://discuss.96boards.org/t/tool-bionic-builder-automated-kernel-ubuntu-builder-for-hikey970/7879) tool that has been posted in the [Hikey970 Support forum](https://discuss.96boards.org/c/products/hikey970). The tool builds kernel version 4.9.78 and allows to pre-configure the Wifi network the board has to connect to. 

After flashing the board with the new image we can get the running kernel `config` by doing:
```
cat /proc/config.gz | gunzip > running.config
```
and copy it to the machine where the kernel will be built on.

#### Host machine preparation
The following is needed in the host machine:
- Download `build.sh` and `ramdisk.img` from [http://people.linaro.org/~manivannan.sadhasivam/hikey970_images/](http://people.linaro.org/~manivannan.sadhasivam/hikey970_images/)
- Copy `running.config` from the board.
- As per instructions in the EVL Project documentation we need to clone [linux-evl](https://git.evlproject.org/linux-evl.git) and [libevl](https://git.evlproject.org/libevl.git) and install the `aarch64` gcc toolchain.

#### Building the EVL-enabled kernel
To build the EVL-enabled kernel:
- Copy the `running.config` into the checkout of `linux-evl` and rename to `.config`.
- Enable the appropriate options as described [here](https://evlproject.org/core/build-steps/#building-evl-core).
- Cross-compile the kernel:
```
make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- dtbs modules Image
```
- Build `boot.img` and flash boot to board using `build.sh` script.

It is also possible to cross-compile `libevl` as described [here](https://evlproject.org/core/build-steps/#cross-compiling-evl) and copy the resulting folder to the board.

#### Checking the installation
Now that the EVL-enabled kernel is on the board we can run the [tests](https://evlproject.org/core/build-steps/#testing-the-installation) that are provided as part of `libevl`.

* **Note**
It is possible that when attempting to run the tests the following error message appears:
```
error while loading shared libraries: libevl.so.0: cannot open shared object file: No such file or directory
```
The error can be solved by adding the path to the EVL libraries to `ldconfig`. Assuming you have installed the library to its default location (`/usr/evl`):
```
$ bash -c 'echo "/usr/evl/lib" > /etc/ld.so.conf.d/evl2.conf'
$ ldconfig
```

##### [latmus](https://evlproject.org/core/build-steps/#latmus-the-litmus-test-for-latency)
```
$ sudo ./latmus -t
== latmus started for core tuning, period=1000 us (may take a while)
irq gravity...0 ns
kernel gravity...1500 ns
user gravity...7500 ns
== tuning completed after 31s
```
##### [hectic](https://evlproject.org/core/build-steps/#hectic-hammering-the-evl-context-switching-machinery)
```
$ sudo ./hectic -s 200
== Testing FPU check routines...
== FPU check routines: OK.
== Threads: switcher_ufps0-0 rtk0-1 rtk0-2 rtup0-3 rtup0-4 rtup_ufpp0-5 rtup_ufpp0-6 rtus0-7 rtus0-8 rtus_ufps0-9 rtus_ufps0-10 rtuo0-11 rtuo0-12 rtuo_ufpp0-13 rtuo_ufpp0-14 rtuo_ufps0-15 rtuo_ufps0-16 rtuo_ufpp_ufps0-17 rtuo_ufpp_ufps0-18 fpu_stress_ufps0-19 switcher_ufps1-0 rtk1-1 rtk1-2 rtup1-3 rtup1-4 rtup_ufpp1-5 rtup_ufpp1-6 rtus1-7 rtus1-8 rtus_ufps1-9 rtus_ufps1-10 rtuo1-11 rtuo1-12 rtuo_ufpp1-13 rtuo_ufpp1-14 rtuo_ufps1-15 rtuo_ufps1-16 rtuo_ufpp_ufps1-17 rtuo_ufpp_ufps1-18 fpu_stress_ufps1-19 switcher_ufps2-0 rtk2-1 rtk2-2 rtup2-3 rtup2-4 rtup_ufpp2-5 rtup_ufpp2-6 rtus2-7 rtus2-8 rtus_ufps2-9 rtus_ufps2-10 rtuo2-11 rtuo2-12 rtuo_ufpp2-13 rtuo_ufpp2-14 rtuo_ufps2-15 rtuo_ufps2-16 rtuo_ufpp_ufps2-17 rtuo_ufpp_ufps2-18 fpu_stress_ufps2-19 switcher_ufps3-0 rtk3-1 rtk3-2 rtup3-3 rtup3-4 rtup_ufpp3-5 rtup_ufpp3-6 rtus3-7 rtus3-8 rtus_ufps3-9 rtus_ufps3-10 rtuo3-11 rtuo3-12 rtuo_ufpp3-13 rtuo_ufpp3-14 rtuo_ufps3-15 rtuo_ufps3-16 rtuo_ufpp_ufps3-17 rtuo_ufpp_ufps3-18 fpu_stress_ufps3-19 switcher_ufps4-0 rtk4-1 rtk4-2 rtup4-3 rtup4-4 rtup_ufpp4-5 rtup_ufpp4-6 rtus4-7 rtus4-8 rtus_ufps4-9 rtus_ufps4-10 rtuo4-11 rtuo4-12 rtuo_ufpp4-13 rtuo_ufpp4-14 rtuo_ufps4-15 rtuo_ufps4-16 rtuo_ufpp_ufps4-17 rtuo_ufpp_ufps4-18 fpu_stress_ufps4-19 switcher_ufps5-0 rtk5-1 rtk5-2 rtup5-3 rtup5-4 rtup_ufpp5-5 rtup_ufpp5-6 rtus5-7 rtus5-8 rtus_ufps5-9 rtus_ufps5-10 rtuo5-11 rtuo5-12 rtuo_ufpp5-13 rtuo_ufpp5-14 rtuo_ufps5-15 rtuo_ufps5-16 rtuo_ufpp_ufps5-17 rtuo_ufpp_ufps5-18 fpu_stress_ufps5-19 switcher_ufps6-0 rtk6-1 rtk6-2 rtup6-3 rtup6-4 rtup_ufpp6-5 rtup_ufpp6-6 rtus6-7 rtus6-8 rtus_ufps6-9 rtus_ufps6-10 rtuo6-11 rtuo6-12 rtuo_ufpp6-13 rtuo_ufpp6-14 rtuo_ufps6-15 rtuo_ufps6-16 rtuo_ufpp_ufps6-17 rtuo_ufpp_ufps6-18 fpu_stress_ufps6-19 switcher_ufps7-0 rtk7-1 rtk7-2 rtup7-3 rtup7-4 rtup_ufpp7-5 rtup_ufpp7-6 rtus7-7 rtus7-8 rtus_ufps7-9 rtus_ufps7-10 rtuo7-11 rtuo7-12 rtuo_ufpp7-13 rtuo_ufpp7-14 rtuo_ufps7-15 rtuo_ufps7-16 rtuo_ufpp_ufps7-17 rtuo_ufpp_ufps7-18 fpu_stress_ufps7-19
RTT|  00:00:01
RTH|---------cpu|ctx switches|-------total
RTD|           6|        4216|        4216
RTD|           3|        4729|        4729
RTD|           7|        3646|        3646
RTD|           4|        4729|        4729
RTD|           5|        4558|        4558
RTD|           2|        4615|        4615
RTD|           1|        3646|        3646
RTD|           0|        3532|        3532
RTD|           6|        3937|        8153
RTD|           3|        3762|        8491
RTD|           7|        4393|        8039
RTD|           5|        3591|        8149
RTD|           4|        4446|        9175
RTD|           2|        3363|        7978
RTD|           1|        4788|        8434
...
```

##### [Unit tests](https://evlproject.org/core/build-steps/#unit-testing)
```
$ for f in /usr/evl/tests/*; do echo $f && sudo $f; done
/usr/evl/tests/basic-xbuf
thread tfd=7
xfd=8
write->oob_read: 4
write->oob_read: 2
write->oob_read: 1
write->oob_read: 1
oob_read[0]<-write: 1 => 0x41
oob_read[1]<-write: 1 => 0x42
oob_read[2]<-write: 1 => 0x43
oob_read[3]<-write: 1 => 0x44
oob_read[4]<-write: 1 => 0x45
oob_read[5]<-write: 1 => 0x46
oob_read[6]<-write: 1 => 0x47
oob_read[7]<-write: 1 => 0x48
dup(6) => 9
dup2(6, 9) => 9
peer reading from fd=6
oob_write->read: 2
oob_write->read: 2
oob_write->read: 2
inband[0] => 01
inband[1] => 23
inband[2] => 45
/usr/evl/tests/clock-timer-periodic
/usr/evl/tests/clone-fork-exec
thread has efd=7
exec() ok for pid 2354
/usr/evl/tests/detach-self
thread efd=7
detach ret=0
thread efd=7
detach ret=0
/usr/evl/tests/duplicate-element
/usr/evl/tests/fault
/usr/evl/tests/fpu-preload
switched inband (fault)
/usr/evl/tests/heap-torture
/usr/evl/tests/mapfd
file proxy has efd=5
mapfd child reading: mapfd-test
/usr/evl/tests/monitor-event
/usr/evl/tests/monitor-flags
/usr/evl/tests/monitor-pi
/usr/evl/tests/monitor-pp-dynamic
/usr/evl/tests/monitor-pp-lower
/usr/evl/tests/monitor-pp-nested
/usr/evl/tests/monitor-pp-pi
/usr/evl/tests/monitor-pp-raise
/usr/evl/tests/monitor-pp-tryenter
/usr/evl/tests/monitor-pp-weak
/usr/evl/tests/monitor-steal
/usr/evl/tests/poll-close
/usr/evl/tests/poll-nested
/usr/evl/tests/poll-read
/usr/evl/tests/proxy-pipe
/usr/evl/tests/sem-close-unblock
/usr/evl/tests/sem-timedwait
/usr/evl/tests/sem-wait
/usr/evl/tests/simple-clone
thread efd=7
```





